<!doctype html>
<html lang="pt-BR" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GAVEBLUE - WEFROTAS - COVRE E CIA LTDA</title>

  <!-- SDK placeholders (preserve your original SDK includes) -->
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>

  <!-- Tailwind CDN (keeps UI familiar) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* --- Reused and improved styles from original file --- */
    body { box-sizing: border-box; }
    .tab-active {
        border-bottom: 2px solid #3b82f6;
        color: #3b82f6;
        background-color: #eff6ff;
    }
    .loading { opacity: 0.6; pointer-events: none; }
    .status-aberta { background-color: #dcfce7; color: #166534; }
    .status-andamento { background-color: #fef3c7; color: #92400e; }
    .status-fechada { background-color: #fee2e2; color: #991b1b; }

    .tab-content { transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; }
    .tab-content.hidden { opacity: 0; transform: translateY(10px); pointer-events: none; height:0; }
    .tab-content:not(.hidden) { opacity: 1; transform: translateY(0); }

    #modal-overlay { backdrop-filter: blur(8px); transition: all 0.3s ease-in-out; }
    #modal-overlay.hidden { opacity: 0; visibility: hidden; }
    #modal-overlay:not(.hidden) { opacity: 1; visibility: visible; }

    #modal-overlay > div { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; transform: scale(0.95) translateY(-20px); }
    #modal-overlay:not(.hidden) > div { transform: scale(1) translateY(0); }

    .hover-lift { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
    .hover-lift:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }

    button, .cursor-pointer { transition: all 0.2s ease-in-out; }

    /* Date input / form niceties (kept from original) */
    .date-input-container { position: relative; display: inline-block; width: 100%; }
    .date-input {
      width: 100%;
      padding: 12px 16px;
      padding-right: 48px;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
      transition: all 0.3s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .date-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.08); }

    /* Toast */
    #global-toast {
      position: fixed;
      right: 20px;
      top: 20px;
      z-index: 60;
      display: none;
      min-width: 200px;
    }
    #global-toast.show { display: block; animation: toast-in 0.25s ease-out; }
    @keyframes toast-in { from { transform: translateX(20px); opacity: 0 } to { transform: translateX(0); opacity: 1 } }

    /* small responsiveness */
    @media (max-width:640px) {
      .date-input { padding: 14px 16px; font-size: 16px; }
    }
  </style>

  <style>@view-transition { navigation: auto; }</style>
 </head>

 <body class="h-full bg-gray-50 font-sans">
  <div class="min-h-full">
   <!-- Header -->
   <header class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
     <div class="flex justify-between items-center py-4">
      <div>
       <h1 id="system-title" class="text-2xl font-bold text-blue-900">gaveblue - wefrotas</h1>
       <p id="company-name" class="text-lg text-blue-700 font-semibold">Sistema Integrado de Gest√£o de Frotas</p>
      </div>
      <div id="header-toast-container" class="flex-1 max-w-md mx-4"></div>
     </div>
    </div>
   </header>

   <!-- Navigation Tabs -->
   <nav class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
     <div id="tabs" class="flex space-x-1 overflow-x-auto">
       <button onclick="showTab('vehicles')" id="tab-vehicles" class="tab-active py-3 px-4 text-sm font-medium whitespace-nowrap rounded-t-lg">VE√çCULOS</button>
       <button onclick="showTab('drivers')" id="tab-drivers" class="py-3 px-4 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap rounded-t-lg">MOTORISTAS</button>
       <button onclick="showTab('orders')" id="tab-orders" class="py-3 px-4 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap rounded-t-lg">OS</button>
       <button onclick="showTab('lancamentos')" id="tab-lancamentos" class="py-3 px-4 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap rounded-t-lg">LAN√áAMENTOS</button>
       <button onclick="showTab('contas')" id="tab-contas" class="py-3 px-4 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap rounded-t-lg relative">CONTAS A PAGAR <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full shadow-lg animate-pulse">NOVO</span></button>
       <button onclick="showTab('cadastros')" id="tab-cadastros" class="py-3 px-4 text-sm font-medium text-gray-500 hover:text-gray-700 whitespace-nowrap rounded-t-lg">CADASTROS</button>
     </div>
    </div>
   </nav>

   <!-- Main Content -->
   <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
    <!-- Contas a Pagar Tab -->
    <div id="contas-content" class="tab-content hidden">
     <div class="bg-white rounded-lg shadow p-6 mb-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
       <h3 class="text-lg font-semibold text-gray-900 flex items-center">Contas a Pagar</h3>
       <div class="flex flex-wrap items-center gap-3">
         <select id="contas-filter-status" onchange="updateContasList()" class="px-3 py-2 border border-gray-300 rounded-md">
           <option value="all">Todas</option>
           <option value="open">Aberta</option>
           <option value="paid">Paga</option>
         </select>
         <button onclick="exportContas()" class="px-3 py-2 bg-green-600 text-white rounded-md">Exportar</button>
       </div>
      </div>
      <div id="contas-summary" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>
      <div id="contas-selection-info" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
       <div class="flex justify-between items-center">
        <p class="text-blue-800 text-sm"><span id="contas-selection-count">0 contas selecionadas</span> - <span id="contas-selection-total">R$ 0,00</span></p>
        <button id="pay-selected-btn" onclick="paySelectedContas()" class="bg-blue-600 text-white px-3 py-2 rounded-md">Pagar Selecionadas</button>
       </div>
      </div>
      <div id="contas-list" class="space-y-4">
       <div class="text-center py-8 text-gray-500">Nenhuma conta encontrada</div>
      </div>
     </div>
    </div>

    <!-- Cadastros Tab -->
    <div id="cadastros-content" class="tab-content hidden">
     <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 mb-6">
      <div class="text-center mb-10">
       <h3 class="text-3xl font-bold text-gray-900 mb-3">Central de Cadastros</h3>
       <p class="text-gray-600 text-lg">Escolha o que deseja cadastrar no sistema</p>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
       <div onclick="showCadastroForm('vehicle')" class="group cursor-pointer bg-white border-2 border-gray-200 rounded-2xl p-8 hover:border-green-400 hover:shadow-xl transition-all duration-300">
        <div class="text-center">
         <div class="mb-6 p-4 bg-green-50 rounded-full w-20 h-20 mx-auto flex items-center justify-center">
          <svg class="w-10 h-10 text-green-600" fill="currentColor" viewBox="0 0 24 24"><path d="M5 11h14v6H5zM4 6h2l1-2h10l1 2h2v5H4z"/></svg>
         </div>
         <h4 class="text-xl font-bold text-gray-900 mb-3">VE√çCULO</h4>
         <p class="text-gray-600">Adicionar novo ve√≠culo √† frota</p>
        </div>
       </div>

       <div onclick="showCadastroForm('driver')" class="group cursor-pointer bg-white border-2 border-gray-200 rounded-2xl p-8 hover:border-purple-400 hover:shadow-xl transition-all duration-300">
        <div class="text-center">
         <div class="mb-6 p-4 bg-purple-50 rounded-full w-20 h-20 mx-auto flex items-center justify-center">
          <svg class="w-10 h-10 text-purple-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM4 20v-1a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v1z"/></svg>
         </div>
         <h4 class="text-xl font-bold text-gray-900 mb-3">MOTORISTA</h4>
         <p class="text-gray-600">Cadastrar novo motorista</p>
        </div>
       </div>

       <div onclick="showCadastroForm('supplier')" class="group cursor-pointer bg-white border-2 border-gray-200 rounded-2xl p-8 hover:border-indigo-400 hover:shadow-xl transition-all duration-300">
        <div class="text-center">
         <div class="mb-6 p-4 bg-indigo-50 rounded-full w-20 h-20 mx-auto flex items-center justify-center">
          <svg class="w-10 h-10 text-indigo-600" fill="currentColor" viewBox="0 0 24 24"><path d="M4 4h16v4H4zM4 12h16v8H4z"/></svg>
         </div>
         <h4 class="text-xl font-bold text-gray-900 mb-3">FORNECEDOR</h4>
         <p class="text-gray-600">Cadastrar postos, oficinas, autope√ßas e outros fornecedores</p>
        </div>
       </div>
      </div>
     </div>

     <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Fornecedores Cadastrados</h3>
      <div id="suppliers-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
       <div class="text-center py-8 text-gray-500">Nenhum fornecedor cadastrado</div>
      </div>
     </div>
    </div>

    <!-- Orders Tab -->
    <div id="orders-content" class="tab-content hidden">
     <div class="bg-white rounded-lg shadow p-6">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
       <h3 class="text-lg font-semibold text-gray-900">Ordens de Servi√ßo</h3>
       <div class="flex flex-wrap items-center gap-3">
        <button onclick="showCadastroForm('order')" class="bg-green-600 text-white px-4 py-2 rounded-md">Nova OS</button>
        <button id="edit-order-btn" onclick="editSelectedOrder()" disabled class="bg-blue-600 text-white px-4 py-2 rounded-md">Editar</button>
        <button id="delete-orders-btn" onclick="deleteSelectedOrders()" disabled class="bg-red-600 text-white px-4 py-2 rounded-md">Excluir</button>
        <select id="order-filter" onchange="updateOrdersList()" class="px-3 py-2 border border-gray-300 rounded-md">
          <option value="all">Todas</option>
          <option value="open">Abertas</option>
          <option value="closed">Fechadas</option>
        </select>

        <div class="date-input-container w-44">
          <input type="date" id="order-date-start" onchange="updateOrdersList()" placeholder="Data inicial" class="date-input text-sm">
        </div>
        <div class="date-input-container w-44">
          <input type="date" id="order-date-end" onchange="updateOrdersList()" placeholder="Data final" class="date-input text-sm">
        </div>
       </div>
      </div>

      <div id="selection-info" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
       <p class="text-blue-800 text-sm"><span id="selection-count">0 OS selecionadas</span></p>
      </div>

      <div id="orders-list" class="space-y-4">
       <div class="text-center py-8 text-gray-500">Nenhuma ordem de servi√ßo cadastrada</div>
      </div>
     </div>
    </div>

    <!-- Vehicles Tab (default visible) -->
    <div id="vehicles-content" class="tab-content">
     <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Ve√≠culos Cadastrados</h3>
      <div id="vehicles-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
       <div class="text-center py-8 text-gray-500">Nenhum ve√≠culo cadastrado</div>
      </div>
     </div>
    </div>

    <!-- Drivers Tab -->
    <div id="drivers-content" class="tab-content hidden">
     <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Motoristas Cadastrados</h3>
      <div id="drivers-list" class="space-y-4">
       <div class="text-center py-8 text-gray-500">Nenhum motorista cadastrado</div>
      </div>
     </div>
    </div>

    <!-- Lancamentos Tab -->
    <div id="lancamentos-content" class="tab-content hidden">
     <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 mb-6">
      <div class="text-center mb-10">
       <h3 class="text-3xl font-bold text-gray-900 mb-3">Central de Lan√ßamentos</h3>
       <p class="text-gray-600 text-lg">Registre despesas e abastecimentos</p>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
       <div onclick="showLancamentoPopup('despesas')" class="group cursor-pointer bg-white border-2 border-gray-200 rounded-2xl p-8 hover:border-red-400 hover:shadow-xl transition-all duration-300">
        <div class="text-center">
         <div class="mb-6 p-4 bg-red-50 rounded-full w-20 h-20 mx-auto flex items-center justify-center">
          <svg class="w-10 h-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 6h18M8 6v12"/></svg>
         </div>
         <h4 class="text-xl font-bold text-gray-900 mb-3">DESPESAS</h4>
         <p class="text-gray-600">Registrar ped√°gios, manuten√ß√µes, multas e outras despesas</p>
        </div>
       </div>

       <div onclick="showLancamentoPopup('abastecimentos')" class="group cursor-pointer bg-white border-2 border-gray-200 rounded-2xl p-8 hover:border-blue-400 hover:shadow-xl transition-all duration-300">
        <div class="text-center">
         <div class="mb-6 p-4 bg-blue-50 rounded-full w-20 h-20 mx-auto flex items-center justify-center">
          <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 12h18M12 3v18"/></svg>
         </div>
         <h4 class="text-xl font-bold text-gray-900 mb-3">ABASTECIMENTOS</h4>
         <p class="text-gray-600">Registrar abastecimentos de combust√≠vel da frota</p>
        </div>
       </div>
      </div>
     </div>

     <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Todos os Lan√ßamentos</h3>
      <div id="all-lancamentos-list" class="space-y-4">
       <div class="text-center py-8 text-gray-500">Nenhum lan√ßamento registrado</div>
      </div>
     </div>
    </div>
   </main>
  </div>

  <!-- Modal Overlay Global -->
  <div id="modal-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
   <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
    <div class="flex justify-between items-center p-6 border-b">
     <h3 id="modal-title" class="text-xl font-semibold text-gray-900"></h3>
     <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">‚úï</button>
    </div>
    <div id="modal-content" class="p-6"><!-- Conte√∫do ser√° inserido aqui dinamicamente --></div>
   </div>
  </div>

  <!-- Toast container -->
  <div id="global-toast" class="bg-white px-4 py-3 rounded shadow"></div>

  <!-- Scripts (application logic) -->
  <script>
    // --- Global state ---
    let allData = [];
    let isInitialized = false;

    // Default config for Element SDK
    const defaultConfig = {
      system_title: "gaveblue - wefrotas",
      company_name: "Sistema Integrado de Gest√£o de Frotas"
    };

    // Data handler for Data SDK
    const dataHandler = {
      onDataChanged(data) {
        console.log('üìä Dados atualizados:', data.length, 'registros');
        allData = Array.isArray(data) ? data.slice() : [];
        updateUI();
      }
    };

    // --- UI helpers ---
    function showToast(message, type = 'info', duration = 3000) {
      const container = document.getElementById('global-toast');
      if (!container) { alert(message); return; }
      container.textContent = message;
      container.classList.add('show');
      if (type === 'success') container.style.borderLeft = '6px solid #10B981';
      else if (type === 'error') container.style.borderLeft = '6px solid #EF4444';
      else container.style.borderLeft = '6px solid #3B82F6';
      clearTimeout(container._toastTimer);
      container._toastTimer = setTimeout(() => {
        container.classList.remove('show');
      }, duration);
    }

    function closeModal() {
      const ov = document.getElementById('modal-overlay');
      if (ov) ov.classList.add('hidden');
      // Clear content to avoid duplicate listeners problems when observer attaches
      // but do not remove form if you want to keep values during editing.
      // document.getElementById('modal-content').innerHTML = '';
    }

    function openModal(title, html) {
      const overlay = document.getElementById('modal-overlay');
      const titleEl = document.getElementById('modal-title');
      const content = document.getElementById('modal-content');
      if (titleEl) titleEl.textContent = title || '';
      if (content) content.innerHTML = html || '';
      if (overlay) overlay.classList.remove('hidden');
      // Focus first input if present
      setTimeout(() => {
        const first = content.querySelector('input, textarea, select, button');
        if (first) first.focus();
      }, 50);
    }

    // Basic UI rendering for lists
    function updateUI() {
      // Vehicles
      const vlist = document.getElementById('vehicles-list');
      const vehicles = allData.filter(i => i._type === 'vehicle');
      if (vlist) {
        if (!vehicles.length) {
          vlist.innerHTML = '<div class="text-center py-8 text-gray-500">Nenhum ve√≠culo cadastrado</div>';
        } else {
          vlist.innerHTML = vehicles.map(v => {
            return `<div class="bg-white rounded-lg p-4 shadow hover-lift">
                      <div class="flex items-center justify-between">
                        <div>
                          <div class="text-sm text-gray-500">${v.codigo || ''} ${v.placa ? '- ' + v.placa : ''}</div>
                          <div class="font-semibold">${v.marca || ''} ${v.modelo || ''}</div>
                          <div class="text-sm text-gray-500">${v.cor ? v.cor + ' ‚Ä¢ ' : ''}${v.odometro ? v.odometro + ' km' : ''}</div>
                        </div>
                        <div class="text-sm text-gray-400">${new Date(v.created_at).toLocaleString()}</div>
                      </div>
                    </div>`;
          }).join('');
        }
      }

      // Drivers
      const dlist = document.getElementById('drivers-list');
      const drivers = allData.filter(i => i._type === 'driver');
      if (dlist) {
        if (!drivers.length) dlist.innerHTML = '<div class="text-center py-8 text-gray-500">Nenhum motorista cadastrado</div>';
        else dlist.innerHTML = drivers.map(d => `<div class="bg-white rounded-lg p-4 shadow">${d.nome || '(sem nome)'}<div class="text-sm text-gray-500">${d.cpf || ''}</div></div>`).join('');
      }

      // Orders
      const olist = document.getElementById('orders-list');
      const orders = allData.filter(i => i._type === 'order');
      if (olist) {
        if (!orders.length) olist.innerHTML = '<div class="text-center py-8 text-gray-500">Nenhuma ordem de servi√ßo cadastrada</div>';
        else olist.innerHTML = orders.map(o => `<div class="bg-white rounded-lg p-4 shadow"><div class="font-semibold">${o.descricao || '(sem descri√ß√£o)'}</div><div class="text-sm text-gray-500">${o.data_abertura || ''}</div></div>`).join('');
      }

      // Suppliers
      const slist = document.getElementById('suppliers-list');
      const suppliers = allData.filter(i => i._type === 'supplier');
      if (slist) {
        if (!suppliers.length) slist.innerHTML = '<div class="text-center py-8 text-gray-500">Nenhum fornecedor cadastrado</div>';
        else slist.innerHTML = suppliers.map(s => `<div class="bg-white rounded-lg p-4 shadow">${s.name || '(sem nome)'}</div>`).join('');
      }

      // Lancamentos (expenses and fueling)
      const allL = document.getElementById('all-lancamentos-list');
      const lancs = allData.filter(i => i._type === 'expense' || i._type === 'fueling');
      if (allL) {
        if (!lancs.length) allL.innerHTML = '<div class="text-center py-8 text-gray-500">Nenhum lan√ßamento registrado</div>';
        else allL.innerHTML = lancs.map(l => `<div class="bg-white rounded-lg p-4 shadow">${l._type} ‚Ä¢ ${l.created_at ? new Date(l.created_at).toLocaleString() : ''} <div class="text-sm text-gray-500">${l.descricao || ''}${l.valor ? ' ‚Äî R$ ' + l.valor : ''}</div></div>`).join('');
      }
    }

    // --- Initialization ---
    async function initializeApp() {
      try {
        console.log('üöÄ Iniciando aplica√ß√£o...');
        // Set today's date defaults
        const today = new Date().toISOString().split('T')[0];
        const fuelingDataInput = document.getElementById('fueling-data');
        const expenseDataInput = document.getElementById('expense-data');
        if (fuelingDataInput) fuelingDataInput.value = today;
        if (expenseDataInput) expenseDataInput.value = today;

        // Init Data SDK (if present)
        if (window.dataSdk && typeof window.dataSdk.init === 'function') {
          const dataResult = await window.dataSdk.init(dataHandler);
          if (dataResult && dataResult.isOk) {
            console.log('‚úÖ Data SDK inicializado');
          } else {
            console.warn('Data SDK init retornou:', dataResult);
          }
        }

        // Init Element SDK (if present)
        if (window.elementSdk && typeof window.elementSdk.init === 'function') {
          window.elementSdk.init({
            defaultConfig,
            onConfigChange: (config) => {
              const titleElement = document.getElementById('system-title');
              const companyElement = document.getElementById('company-name');
              if (titleElement) titleElement.textContent = config.system_title || defaultConfig.system_title;
              if (companyElement) companyElement.textContent = config.company_name || defaultConfig.company_name;
            },
            mapToCapabilities: (config) => ({ recolorables: [], borderables: [], fontEditable: undefined, fontSizeable: undefined }),
            mapToEditPanelValues: (config) => new Map([ ["system_title", config.system_title || defaultConfig.system_title], ["company_name", config.company_name || defaultConfig.company_name] ])
          });
          console.log('‚úÖ Element SDK inicializado');
        }

        setupEventListeners();

        // Load local storage initial data (if present)
        if (window.gaveblueLocalStorage && typeof window.gaveblueLocalStorage.getAll === 'function') {
          const local = window.gaveblueLocalStorage.getAll();
          if (Array.isArray(local) && local.length) {
            allData = local.slice();
            if (typeof dataHandler.onDataChanged === 'function') dataHandler.onDataChanged(allData);
          }
        }

        updateUI();
        isInitialized = true;
        console.log('üéâ Aplica√ß√£o inicializada com sucesso!');
      } catch (err) {
        console.error('Erro na inicializa√ß√£o', err);
        showToast('Erro ao inicializar o sistema', 'error');
      }
    }

    function setupEventListeners() {
      console.log('üîó Configurando event listeners...');
      const orderFilter = document.getElementById('order-filter');
      if (orderFilter) orderFilter.addEventListener('change', updateOrdersList);

      const expenseForm = document.getElementById('expense-form');
      if (expenseForm) expenseForm.addEventListener('submit', handleExpenseSubmit);

      const fuelingForm = document.getElementById('fueling-form');
      if (fuelingForm) fuelingForm.addEventListener('submit', handleFuelingSubmit);

      console.log('‚úÖ Event listeners configurados');
    }

    function updateOrdersList() { /* placeholder: filter is applied in updateUI which reads allData */ console.log('updateOrdersList called'); }

    function updateContasList() { console.log('updateContasList called'); }

    function exportContas() { showToast('Exportar n√£o implementado (teste localStorage)', 'info'); }

    function paySelectedContas() { showToast('Pagar selecionadas ‚Äî placeholder', 'info'); }

    function editSelectedOrder(){ showToast('Editar OS ‚Äî placeholder', 'info'); }

    function deleteSelectedOrders(){ showToast('Excluir OS ‚Äî placeholder', 'info'); }

    function exportSelectedOrder(){ showToast('Exportar OS ‚Äî placeholder', 'info'); }

    function showLancamentoPopup(type) {
      if (type === 'despesas') showCadastroForm('expense');
      else if (type === 'abastecimentos') showCadastroForm('fueling');
      else showCadastroForm('expense');
    }

    // --- showCadastroForm: inject prebuilt forms into modal-content ---
    function showCadastroForm(type) {
      const formConfigs = {
        vehicle: {
          title: 'Cadastrar Novo Ve√≠culo',
          html: `
            <form id="dynamic-vehicle-form" class="space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-700">C√≥digo da Frota *</label><input id="dynamic-vehicle-codigo" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">Placa *</label><input id="dynamic-vehicle-placa" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">Marca</label><input id="dynamic-vehicle-marca" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">Modelo</label><input id="dynamic-vehicle-modelo" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">Ano Fabrica√ß√£o</label><input id="dynamic-vehicle-ano" type="number" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">Ano Modelo</label><input id="dynamic-vehicle-ano-modelo" type="number" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">Cor</label><input id="dynamic-vehicle-cor" class="w-full px-3 py-2 border rounded" /></div>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-700">Chassi</label><input id="dynamic-vehicle-chassi" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">RENAVAM</label><input id="dynamic-vehicle-renavam" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">Od√¥metro Atual (km)</label><input id="dynamic-vehicle-odometro" type="number" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">Combust√≠vel</label>
                  <select id="dynamic-vehicle-combustivel" class="w-full px-3 py-2 border rounded">
                    <option value="">Selecione</option><option>Gasolina</option><option>Etanol</option><option>Flex</option><option>Diesel</option><option>GNV</option>
                  </select>
                </div>
                <div><label class="block text-sm font-medium text-gray-700">Categoria</label>
                  <select id="dynamic-vehicle-categoria" class="w-full px-3 py-2 border rounded"><option value="">Selecione</option><option>Carro</option><option>Caminh√£o</option><option>Van</option><option>Moto</option><option>√înibus</option></select>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700">Observa√ß√µes</label>
                <textarea id="dynamic-vehicle-observacoes" rows="3" class="w-full px-3 py-2 border rounded"></textarea>
              </div>

              <div class="flex justify-end">
                <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded">Cadastrar Ve√≠culo</button>
              </div>
            </form>
          `
        },

        driver: {
          title: 'Cadastrar Novo Motorista',
          html: `
            <form id="dynamic-driver-form" class="space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-700">Nome Completo *</label><input id="dynamic-driver-nome" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">CPF *</label><input id="dynamic-driver-cpf" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">RG</label><input id="dynamic-driver-rg" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">Data de Nascimento</label><input id="dynamic-driver-nascimento" type="date" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">Telefone</label><input id="dynamic-driver-telefone" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">E-mail</label><input id="dynamic-driver-email" type="email" class="w-full px-3 py-2 border rounded" /></div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-700">Endere√ßo</label><input id="dynamic-driver-endereco" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">Bairro</label><input id="dynamic-driver-bairro" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">CEP</label><input id="dynamic-driver-cep" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">Cidade</label><input id="dynamic-driver-cidade" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">Estado</label><select id="dynamic-driver-estado" class="w-full px-3 py-2 border rounded"><option value="">Selecione</option><option>SP</option><option>RJ</option><option>MG</option></select></div>
              </div>

              <div class="flex justify-end">
                <button type="submit" class="bg-purple-600 text-white px-6 py-2 rounded">Cadastrar Motorista</button>
              </div>
            </form>
          `
        },

        order: {
          title: 'Nova Ordem de Servi√ßo',
          html: `
            <form id="dynamic-order-form" class="space-y-6">
              <div>
                <label class="block text-sm font-medium text-gray-700">Descri√ß√£o *</label>
                <input id="dynamic-order-descricao" class="w-full px-3 py-2 border rounded" />
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-700">Data de Abertura</label><input id="dynamic-order-data-abertura" type="date" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">Previs√£o de T√©rmino</label><input id="dynamic-order-previsao-termino" type="date" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">Prioridade</label><select id="dynamic-order-prioridade" class="w-full px-3 py-2 border rounded"><option>Normal</option><option>Alta</option><option>Urgente</option></select></div>
                <div><label class="block text-sm font-medium text-gray-700">Respons√°vel</label><input id="dynamic-order-responsavel" class="w-full px-3 py-2 border rounded" /></div>
              </div>

              <div><label class="block text-sm font-medium text-gray-700">Observa√ß√µes</label><textarea id="dynamic-order-observacoes" rows="3" class="w-full px-3 py-2 border rounded"></textarea></div>

              <div class="flex justify-end">
                <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded">Criar Ordem de Servi√ßo</button>
              </div>
            </form>
          `
        },

        expense: {
          title: 'Registrar Despesa',
          html: `
            <form id="dynamic-expense-form" class="space-y-6">
              <div><label class="block text-sm font-medium text-gray-700">Ordem de Servi√ßo</label><input id="expense-order" class="w-full px-3 py-2 border rounded" /></div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-700">Tipo</label><select id="expense-tipo" class="w-full px-3 py-2 border rounded"><option>Manuten√ß√£o</option><option>Multa</option></select></div>
                <div><label class="block text-sm font-medium text-gray-700">Data</label><input id="expense-data" type="date" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">Valor (R$)</label><input id="expense-valor" type="number" step="0.01" class="w-full px-3 py-2 border rounded" /></div>
              </div>
              <div><label class="block text-sm font-medium text-gray-700">Descri√ß√£o</label><input id="expense-descricao" class="w-full px-3 py-2 border rounded" /></div>
              <div class="flex justify-end"><button class="bg-red-600 text-white px-6 py-2 rounded" type="submit">Registrar Despesa</button></div>
            </form>
          `
        },

        fueling: {
          title: 'Registrar Abastecimento',
          html: `
            <form id="dynamic-fueling-form" class="space-y-6">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium text-gray-700">Ve√≠culo</label><input id="fueling-vehicle" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">Ordem de Servi√ßo</label><input id="fueling-order" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">Posto</label><input id="fueling-station" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">Data</label><input id="fueling-data" type="date" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">KM Atual</label><input id="fueling-km" type="number" class="w-full px-3 py-2 border rounded" /></div>
                <div><label class="block text-sm font-medium text-gray-700">Litros</label><input id="fueling-litros" type="number" step="0.01" class="w-full px-3 py-2 border rounded" /></div>
              </div>
              <div><label class="block text-sm font-medium text-gray-700">Valor Total (R$)</label><input id="fueling-valor" type="number" step="0.01" class="w-full px-3 py-2 border rounded" /></div>
              <div class="flex justify-end"><button class="bg-orange-600 text-white px-6 py-2 rounded" type="submit">Registrar Abastecimento</button></div>
            </form>
          `
        },

        supplier: {
          title: 'Cadastrar Fornecedor',
          html: `
            <form id="dynamic-supplier-form" class="space-y-6">
              <div><label class="block text-sm font-medium text-gray-700">Nome</label><input id="dynamic-supplier-name" class="w-full px-3 py-2 border rounded" /></div>
              <div><label class="block text-sm font-medium text-gray-700">Tipo</label><input id="dynamic-supplier-type" class="w-full px-3 py-2 border rounded" /></div>
              <div class="flex justify-end"><button class="bg-indigo-600 text-white px-6 py-2 rounded" type="submit">Cadastrar Fornecedor</button></div>
            </form>
          `
        }
      };

      const cfg = formConfigs[type] || formConfigs['vehicle'];
      openModal(cfg.title, cfg.html);
      // Observer-based auto-attach will bind handlers when form is inserted.
    }

    // --- Simple submit handlers for static forms if present in DOM ---
    async function handleExpenseSubmit(e) {
      e.preventDefault();
      const record = { _type: 'expense', created_at: new Date().toISOString(), descricao: (document.getElementById('expense-descricao')?.value || ''), valor: (document.getElementById('expense-valor')?.value || '') };
      if (window.gaveblueLocalStorage && window.gaveblueLocalStorage.saveRecordLocal) {
        await window.gaveblueLocalStorage.saveRecordLocal(record);
      } else {
        allData.push(record); updateUI();
      }
      showToast('Despesa registrada', 'success');
      closeModal();
    }

    async function handleFuelingSubmit(e) {
      e.preventDefault();
      const record = { _type: 'fueling', created_at: new Date().toISOString(), vehicle: (document.getElementById('fueling-vehicle')?.value || ''), litros: (document.getElementById('fueling-litros')?.value || ''), valor: (document.getElementById('fueling-valor')?.value || '') };
      if (window.gaveblueLocalStorage && window.gaveblueLocalStorage.saveRecordLocal) {
        await window.gaveblueLocalStorage.saveRecordLocal(record);
      } else {
        allData.push(record); updateUI();
      }
      showToast('Abastecimento registrado', 'success');
      closeModal();
    }

    // Tab switching
    function showTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('#tabs button').forEach(b => b.classList.remove('tab-active'));
      const el = document.getElementById(tabId + '-content');
      const btn = document.getElementById('tab-' + tabId);
      if (el) el.classList.remove('hidden');
      if (btn) btn.classList.add('tab-active');
    }

    // Launch initialization
    document.addEventListener('DOMContentLoaded', () => {
      // show default tab
      showTab('vehicles');
      initializeApp();
    });
  </script>

  <!-- LocalStorage helper & MutationObserver: auto-attaches handlers to dynamic forms -->
  <script>
  (function () {
    // Local storage key
    const LS_KEY = 'gaveblue_local_data_v1';

    function getLocalData() {
      try { const raw = localStorage.getItem(LS_KEY); if (!raw) return []; return JSON.parse(raw); } catch (err) { console.error('Erro ao ler localStorage', err); return []; }
    }

    function setLocalData(arr) {
      try { localStorage.setItem(LS_KEY, JSON.stringify(arr)); } catch (err) { console.error('Erro ao gravar localStorage', err); }
    }

    async function saveRecordLocal(record) {
      const data = getLocalData();
      data.push(record);
      setLocalData(data);
      try {
        if (Array.isArray(window.allData)) window.allData.push(record);
        else window.allData = getLocalData().slice();
        if (window.dataHandler && typeof window.dataHandler.onDataChanged === 'function') {
          try { window.dataHandler.onDataChanged(window.allData); } catch(e){ console.warn(e); }
        }
        console.log('‚úÖ Registro salvo localmente', record);
      } catch (err) {
        console.error('Erro ao sincronizar allData', err);
      }
    }

    function safeShowToast(msg, type) { if (typeof window.showToast === 'function') return window.showToast(msg, type); console.log('[toast]', type || 'info', msg); }
    function safeCloseModal() { if (typeof window.closeModal === 'function') return window.closeModal(); const ov = document.getElementById('modal-overlay'); if (ov) ov.classList.add('hidden'); }

    const attachedForms = new Set();

    function attachForType(type) {
      if (!type) return;
      const formId = `dynamic-${type}-form`;
      if (attachedForms.has(formId)) return;
      const form = document.getElementById(formId);
      if (!form) return;

      console.log('üîå Ligando handler para', formId);
      const submitHandler = async (e) => {
        e.preventDefault();
        const now = new Date().toISOString();
        let record = { _type: type, created_at: now };

        try {
          if (type === 'vehicle') {
            record = Object.assign(record, {
              codigo: (document.getElementById('dynamic-vehicle-codigo')?.value || '').trim(),
              placa: (document.getElementById('dynamic-vehicle-placa')?.value || '').trim(),
              marca: (document.getElementById('dynamic-vehicle-marca')?.value || '').trim(),
              modelo: (document.getElementById('dynamic-vehicle-modelo')?.value || '').trim(),
              ano_fabricacao: (document.getElementById('dynamic-vehicle-ano')?.value || '').trim(),
              ano_modelo: (document.getElementById('dynamic-vehicle-ano-modelo')?.value || '').trim(),
              cor: (document.getElementById('dynamic-vehicle-cor')?.value || '').trim(),
              chassi: (document.getElementById('dynamic-vehicle-chassi')?.value || '').trim(),
              renavam: (document.getElementById('dynamic-vehicle-renavam')?.value || '').trim(),
              odometro: (document.getElementById('dynamic-vehicle-odometro')?.value || '').trim(),
              combustivel: (document.getElementById('dynamic-vehicle-combustivel')?.value || '').trim(),
              categoria: (document.getElementById('dynamic-vehicle-categoria')?.value || '').trim(),
              observacoes: (document.getElementById('dynamic-vehicle-observacoes')?.value || '').trim()
            });
          } else if (type === 'driver') {
            record = Object.assign(record, {
              nome: (document.getElementById('dynamic-driver-nome')?.value || '').trim(),
              cpf: (document.getElementById('dynamic-driver-cpf')?.value || '').trim(),
              rg: (document.getElementById('dynamic-driver-rg')?.value || '').trim(),
              nascimento: (document.getElementById('dynamic-driver-nascimento')?.value || '').trim(),
              telefone: (document.getElementById('dynamic-driver-telefone')?.value || '').trim(),
              email: (document.getElementById('dynamic-driver-email')?.value || '').trim(),
              endereco: (document.getElementById('dynamic-driver-endereco')?.value || '').trim(),
              bairro: (document.getElementById('dynamic-driver-bairro')?.value || '').trim(),
              cep: (document.getElementById('dynamic-driver-cep')?.value || '').trim(),
              cidade: (document.getElementById('dynamic-driver-cidade')?.value || '').trim(),
              estado: (document.getElementById('dynamic-driver-estado')?.value || '').trim()
            });
          } else if (type === 'order') {
            record = Object.assign(record, {
              descricao: (document.getElementById('dynamic-order-descricao')?.value || '').trim(),
              data_abertura: (document.getElementById('dynamic-order-data-abertura')?.value || '').trim(),
              previsao_termino: (document.getElementById('dynamic-order-previsao-termino')?.value || '').trim(),
              prioridade: (document.getElementById('dynamic-order-prioridade')?.value || '').trim(),
              responsavel: (document.getElementById('dynamic-order-responsavel')?.value || '').trim(),
              observacoes: (document.getElementById('dynamic-order-observacoes')?.value || '').trim()
            });
          } else if (type === 'expense') {
            record = Object.assign(record, {
              ordem: (document.getElementById('expense-order')?.value || '').trim(),
              tipo: (document.getElementById('expense-tipo')?.value || '').trim(),
              data: (document.getElementById('expense-data')?.value || '').trim(),
              valor: (document.getElementById('expense-valor')?.value || '').trim(),
              descricao: (document.getElementById('expense-descricao')?.value || '').trim()
            });
            record._type = 'expense';
          } else if (type === 'fueling') {
            record = Object.assign(record, {
              vehicle: (document.getElementById('fueling-vehicle')?.value || '').trim(),
              ordem: (document.getElementById('fueling-order')?.value || '').trim(),
              station: (document.getElementById('fueling-station')?.value || '').trim(),
              data: (document.getElementById('fueling-data')?.value || '').trim(),
              km: (document.getElementById('fueling-km')?.value || '').trim(),
              litros: (document.getElementById('fueling-litros')?.value || '').trim(),
              valor: (document.getElementById('fueling-valor')?.value || '').trim()
            });
            record._type = 'fueling';
          } else {
            Array.from(form.elements).forEach(el => {
              if (!el.name && !el.id) return;
              const key = el.name || el.id;
              if (el.type === 'checkbox') record[key] = !!el.checked;
              else record[key] = el.value;
            });
          }

          // save
          if (window.gaveblueLocalStorage && typeof window.gaveblueLocalStorage.saveRecordLocal === 'function') {
            await window.gaveblueLocalStorage.saveRecordLocal(record);
          } else {
            await saveRecordLocal(record);
          }

          safeShowToast((type[0] ? type[0].toUpperCase() + type.slice(1) : type) + ' cadastrado com sucesso', 'success');
          safeCloseModal();
        } catch (err) {
          console.error('Erro ao submeter formul√°rio', err);
          safeShowToast('Erro ao salvar (ver console)', 'error');
        }
      };

      form.addEventListener('submit', submitHandler);
      attachedForms.add(formId);
    }

    function capitalize(s) { return (s && s[0] ? s[0].toUpperCase() + s.slice(1) : s); }

    function initModalObserver() {
      const modalContent = document.getElementById('modal-content');
      if (!modalContent) {
        console.warn('modal-content n√£o encontrado ‚Äî observer n√£o instalado');
        return;
      }

      const observer = new MutationObserver((mutations) => {
        for (const m of mutations) {
          if (m.type === 'childList' && m.addedNodes.length) {
            m.addedNodes.forEach(node => {
              if (node.nodeType !== 1) return;
              if (node.tagName === 'FORM') {
                const id = node.id || '';
                if (id.startsWith('dynamic-') && id.endsWith('-form')) {
                  const type = id.replace(/^dynamic-/, '').replace(/-form$/, '');
                  attachForType(type);
                }
              }
              if (node.querySelectorAll) {
                node.querySelectorAll('form[id^="dynamic-"]').forEach(f => {
                  const id = f.id; const type = id.replace(/^dynamic-/, '').replace(/-form$/, '');
                  attachForType(type);
                });
              }
            });
          }
        }
      });

      observer.observe(modalContent, { childList: true, subtree: true });

      // Bind existing forms (if any)
      modalContent.querySelectorAll && modalContent.querySelectorAll('form[id^="dynamic-"]').forEach(f => {
        const id = f.id; const type = id.replace(/^dynamic-/, '').replace(/-form$/, '');
        attachForType(type);
      });

      console.log('üîç Modal MutationObserver ativo para attach de formul√°rios din√¢micos');
    }

    // Expose API
    window.gaveblueLocalStorage = {
      getAll: getLocalData,
      clearAll: function() { localStorage.removeItem(LS_KEY); window.allData = []; if (window.dataHandler && typeof window.dataHandler.onDataChanged === 'function') window.dataHandler.onDataChanged([]); },
      saveRecordLocal
    };

    if (document.readyState === 'complete' || document.readyState === 'interactive') setTimeout(initModalObserver, 0);
    else document.addEventListener('DOMContentLoaded', initModalObserver);
  })();
  </script>
 </body>
</html>
