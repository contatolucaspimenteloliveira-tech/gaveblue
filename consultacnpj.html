<!doctype html>
<html lang="pt-BR" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consulta CNPJ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      box-sizing: border-box;
    }
    * {
      font-family: 'Space Grotesk', sans-serif;
    }
    .gradient-bg {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
    }
    .card-glass {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .input-glow:focus {
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in {
      animation: fadeIn 0.3s ease-out forwards;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .spinner {
      animation: spin 1s linear infinite;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full gradient-bg text-white overflow-auto">
  <div class="w-full h-full p-4 md:p-8 overflow-auto">
   <div class="max-w-4xl mx-auto"><!-- Header -->
    <header class="text-center mb-8">
     <div class="inline-flex items-center gap-3 mb-4">
      <svg class="w-10 h-10 text-blue-400" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
      </svg>
      <h1 id="app-title" class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-blue-400 to-cyan-300 bg-clip-text text-transparent">Consulta CNPJ</h1>
     </div>
     <p class="text-slate-400 text-sm md:text-base">Consulte informações de empresas brasileiras</p>
    </header><!-- Search Section -->
    <section class="card-glass rounded-2xl p-6 mb-6">
     <form id="search-form" class="flex flex-col sm:flex-row gap-4">
      <div class="flex-1 relative"><label for="cnpj-input" class="sr-only">CNPJ</label>
       <div class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
       </div><input type="text" id="cnpj-input" placeholder="Digite o CNPJ (apenas números)" class="w-full bg-slate-800/50 border border-slate-600 rounded-xl py-4 pl-12 pr-4 text-white placeholder-slate-500 input-glow focus:outline-none focus:border-blue-500 transition-all" maxlength="18">
      </div><button type="submit" id="search-btn" class="px-8 py-4 bg-blue-600 hover:bg-blue-500 disabled:bg-slate-600 disabled:cursor-not-allowed rounded-xl font-semibold transition-all flex items-center justify-center gap-2 min-w-[140px]"> <span id="btn-text">Consultar</span>
       <svg id="btn-spinner" class="w-5 h-5 spinner hidden" fill="none" viewbox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" /> <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" />
       </svg></button>
     </form><!-- Error/Status Message -->
     <div id="status-message" class="mt-4 hidden"></div>
    </section><!-- Result Section -->
    <section id="result-section" class="card-glass rounded-2xl p-6 mb-6 hidden fade-in">
     <div class="flex items-center justify-between mb-6">
      <h2 class="text-xl font-semibold text-blue-400">Resultado da Consulta</h2><button id="save-btn" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-sm font-medium transition-all flex items-center gap-2">
       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
       </svg> Salvar </button>
     </div>
     <div id="result-content" class="grid gap-4"><!-- Results will be inserted here -->
     </div>
    </section><!-- History Section -->
    <section id="history-section" class="card-glass rounded-2xl p-6">
     <div class="flex items-center justify-between mb-6">
      <h2 class="text-xl font-semibold text-cyan-400">Histórico de Consultas</h2><span id="history-count" class="text-slate-400 text-sm">0 registros</span>
     </div>
     <div id="history-list" class="space-y-3">
      <p class="text-slate-500 text-center py-8">Nenhuma consulta salva ainda</p>
     </div>
    </section>
   </div>
  </div>
  <script>
    // Configuration
    const defaultConfig = {
      app_title: 'Consulta CNPJ',
      search_placeholder: 'Digite o CNPJ (apenas números)',
      primary_color: '#3b82f6',
      secondary_color: '#06b6d4',
      background_color: '#0f172a',
      surface_color: '#1e293b',
      text_color: '#f8fafc'
    };

    let config = { ...defaultConfig };
    let currentResult = null;
    let historyData = [];

    // DOM Elements
    const elements = {
      appTitle: document.getElementById('app-title'),
      cnpjInput: document.getElementById('cnpj-input'),
      searchForm: document.getElementById('search-form'),
      searchBtn: document.getElementById('search-btn'),
      btnText: document.getElementById('btn-text'),
      btnSpinner: document.getElementById('btn-spinner'),
      statusMessage: document.getElementById('status-message'),
      resultSection: document.getElementById('result-section'),
      resultContent: document.getElementById('result-content'),
      saveBtn: document.getElementById('save-btn'),
      historyList: document.getElementById('history-list'),
      historyCount: document.getElementById('history-count')
    };

    // Format CNPJ
    function formatCNPJ(value) {
      const numbers = value.replace(/\D/g, '');
      return numbers.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
    }

    // Clean CNPJ
    function cleanCNPJ(value) {
      return value.replace(/\D/g, '');
    }

    // Show status message
    function showStatus(message, type = 'error') {
      const colors = {
        error: 'bg-red-500/20 border-red-500 text-red-300',
        success: 'bg-emerald-500/20 border-emerald-500 text-emerald-300',
        info: 'bg-blue-500/20 border-blue-500 text-blue-300'
      };
      
      elements.statusMessage.className = `mt-4 p-4 rounded-xl border ${colors[type]} fade-in`;
      elements.statusMessage.textContent = message;
      elements.statusMessage.classList.remove('hidden');
    }

    // Hide status message
    function hideStatus() {
      elements.statusMessage.classList.add('hidden');
    }

    // Set loading state
    function setLoading(loading) {
      elements.searchBtn.disabled = loading;
      elements.btnText.textContent = loading ? 'Consultando...' : 'Consultar';
      elements.btnSpinner.classList.toggle('hidden', !loading);
    }

    // Render result
    function renderResult(data) {
      const situacaoColor = data.situacao === 'ATIVA' ? 'text-emerald-400' : 'text-red-400';
      
      const fields = [
        { label: 'CNPJ', value: formatCNPJ(data.cnpj) || '-' },
        { label: 'Razão Social', value: data.razao_social || '-' },
        { label: 'Nome Fantasia', value: data.nome_fantasia || '-' },
        { label: 'Situação', value: data.situacao || '-', colorClass: situacaoColor },
        { label: 'Data de Abertura', value: data.data_abertura || '-' },
        { label: 'Natureza Jurídica', value: data.natureza_juridica || '-' },
        { label: 'Porte', value: data.porte || '-' },
        { label: 'Capital Social', value: data.capital_social ? `R$ ${Number(data.capital_social).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}` : '-' },
        { label: 'Atividade Principal', value: data.atividade_principal || '-' },
        { label: 'Logradouro', value: data.logradouro ? `${data.logradouro}, ${data.numero || 'S/N'}` : '-' },
        { label: 'Bairro', value: data.bairro || '-' },
        { label: 'Cidade/UF', value: data.municipio ? `${data.municipio}/${data.uf}` : '-' },
        { label: 'CEP', value: data.cep || '-' },
        { label: 'Telefone', value: data.telefone || '-' },
        { label: 'E-mail', value: data.email || '-' }
      ];

      elements.resultContent.innerHTML = fields.map(field => `
        <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-4 py-3 border-b border-slate-700/50 last:border-0">
          <span class="text-slate-400 text-sm sm:w-40 shrink-0">${field.label}</span>
          <span class="font-medium ${field.colorClass || 'text-white'} break-all">${field.value}</span>
        </div>
      `).join('');

      elements.resultSection.classList.remove('hidden');
      currentResult = data;
    }

    // Fetch CNPJ data from API
    async function fetchCNPJ(cnpj) {
      const cleanedCNPJ = cleanCNPJ(cnpj);
      
      if (cleanedCNPJ.length !== 14) {
        showStatus('CNPJ deve conter 14 dígitos');
        return null;
      }

      setLoading(true);
      hideStatus();

      // Seu token da Invertexto
      const token = '24545|2SU374bF2kHG530rYrVHIys6m2leLk2a';
      const url = `https://api.invertexto.com/v1/cnpj/${cleanedCNPJ}?token=${encodeURIComponent(token)}`;

      try {
        const response = await fetch(url);

        // Captura o texto da resposta para debug
        const raw = await response.text();
        
        if (!response.ok) {
          console.error('Erro Invertexto:', response.status, raw);
          showStatus(`Erro na API (${response.status}): ${raw}`);
          return null;
        }

        // Parse JSON após validação
        const data = JSON.parse(raw);

        // Adaptar os campos conforme retorno da Invertexto
        return {
          cnpj: cleanedCNPJ,
          razao_social: data.razao_social ?? data.nome ?? 'Não informado',
          nome_fantasia: data.nome_fantasia ?? 'Não informado',
          situacao: data.situacao ?? 'Não informado',
          data_abertura: data.data_abertura ?? 'Não informado',
          natureza_juridica: data.natureza_juridica ?? 'Não informado',
          porte: data.porte ?? 'Não informado',
          capital_social: data.capital_social ? `${Number(data.capital_social).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}` : 'Não informado',
          atividade_principal: data.atividade_principal ?? 'Não informado',
          logradouro: data.logradouro ?? 'Não informado',
          numero: data.numero ?? 'S/N',
          bairro: data.bairro ?? 'Não informado',
          municipio: data.municipio ?? 'Não informado',
          uf: data.uf ?? 'Não informado',
          cep: data.cep ?? 'Não informado',
          telefone: data.telefone ?? 'Não informado',
          email: data.email ?? 'Não informado'
        };

      } catch (error) {
        console.error('Falha fetch:', error);
        showStatus('Falha ao consultar. Verifique o token e a conexão');
        return null;
      } finally {
        setLoading(false);
      }
    }

    // Save to history
    async function saveToHistory() {
      if (!currentResult) return;

      if (historyData.length >= 999) {
        showStatus('Limite de 999 registros atingido');
        return;
      }

      const existingRecord = historyData.find(item => cleanCNPJ(item.cnpj) === cleanCNPJ(currentResult.cnpj));
      if (existingRecord) {
        showStatus('Este CNPJ já está salvo no histórico', 'info');
        return;
      }

      elements.saveBtn.disabled = true;
      elements.saveBtn.innerHTML = '<svg class="w-4 h-4 spinner" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/></svg> Salvando...';

      const record = {
        cnpj: currentResult.cnpj,
        razao_social: currentResult.razao_social || '',
        nome_fantasia: currentResult.nome_fantasia || '',
        situacao: currentResult.situacao || '',
        data_consulta: new Date().toISOString()
      };

      const result = await window.dataSdk.create(record);
      
      elements.saveBtn.disabled = false;
      elements.saveBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg> Salvar';

      if (result.isOk) {
        showStatus('CNPJ salvo com sucesso!', 'success');
        setTimeout(hideStatus, 3000);
      } else {
        showStatus('Erro ao salvar');
      }
    }

    // Delete from history
    async function deleteFromHistory(record) {
      const itemElement = document.querySelector(`[data-id="${record.__backendId}"]`);
      if (!itemElement) return;

      const deleteBtn = itemElement.querySelector('.delete-btn');
      if (deleteBtn.dataset.confirming === 'true') {
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '<svg class="w-4 h-4 spinner" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg>';
        
        const result = await window.dataSdk.delete(record);
        
        if (!result.isOk) {
          deleteBtn.disabled = false;
          deleteBtn.dataset.confirming = 'false';
          deleteBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>';
          showStatus('Erro ao deletar');
        }
      } else {
        deleteBtn.dataset.confirming = 'true';
        deleteBtn.classList.remove('hover:bg-red-500/20', 'text-red-400');
        deleteBtn.classList.add('bg-red-600', 'text-white');
        deleteBtn.textContent = 'Confirmar?';
        
        setTimeout(() => {
          if (deleteBtn.dataset.confirming === 'true') {
            deleteBtn.dataset.confirming = 'false';
            deleteBtn.classList.add('hover:bg-red-500/20', 'text-red-400');
            deleteBtn.classList.remove('bg-red-600', 'text-white');
            deleteBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>';
          }
        }, 3000);
      }
    }

    // Render history
    function renderHistory(data) {
      historyData = data;
      elements.historyCount.textContent = `${data.length} registro${data.length !== 1 ? 's' : ''}`;

      if (data.length === 0) {
        elements.historyList.innerHTML = '<p class="text-slate-500 text-center py-8">Nenhuma consulta salva ainda</p>';
        return;
      }

      const sortedData = [...data].sort((a, b) => new Date(b.data_consulta) - new Date(a.data_consulta));
      const fragment = document.createDocumentFragment();

      sortedData.forEach(item => {
        const div = document.createElement('div');
        div.dataset.id = item.__backendId;
        div.className = 'bg-slate-800/50 rounded-xl p-4 flex flex-col sm:flex-row sm:items-center justify-between gap-3 fade-in';
        div.innerHTML = `
          <div class="flex-1 min-w-0">
            <p class="font-medium text-white truncate">${item.razao_social || 'Não informado'}</p>
            <p class="text-slate-400 text-sm">${formatCNPJ(item.cnpj)}</p>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-xs px-2 py-1 rounded-full ${item.situacao === 'ATIVA' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'}">${item.situacao || '-'}</span>
            <button class="delete-btn p-2 rounded-lg hover:bg-red-500/20 text-red-400 transition-all" data-confirming="false">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            </button>
          </div>
        `;
        
        div.querySelector('.delete-btn').addEventListener('click', () => deleteFromHistory(item));
        fragment.appendChild(div);
      });

      elements.historyList.innerHTML = '';
      elements.historyList.appendChild(fragment);
    }

    // Update UI from config
    function updateUI() {
      elements.appTitle.textContent = config.app_title || defaultConfig.app_title;
      elements.cnpjInput.placeholder = config.search_placeholder || defaultConfig.search_placeholder;
    }

    // Data handler
    const dataHandler = {
      onDataChanged(data) {
        renderHistory(data);
      }
    };

    // Element SDK implementation
    const elementImpl = {
      defaultConfig,
      onConfigChange: async (newConfig) => {
        config = { ...defaultConfig, ...newConfig };
        updateUI();
      },
      mapToCapabilities: (cfg) => ({
        recolorables: [
          {
            get: () => cfg.primary_color || defaultConfig.primary_color,
            set: (value) => { cfg.primary_color = value; window.elementSdk.setConfig({ primary_color: value }); }
          },
          {
            get: () => cfg.background_color || defaultConfig.background_color,
            set: (value) => { cfg.background_color = value; window.elementSdk.setConfig({ background_color: value }); }
          }
        ],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      }),
      mapToEditPanelValues: (cfg) => new Map([
        ['app_title', cfg.app_title || defaultConfig.app_title],
        ['search_placeholder', cfg.search_placeholder || defaultConfig.search_placeholder]
      ])
    };

    // Event Listeners
    elements.cnpjInput.addEventListener('input', (e) => {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 14) value = value.slice(0, 14);
      
      if (value.length > 2) value = value.replace(/^(\d{2})/, '$1.');
      if (value.length > 6) value = value.replace(/^(\d{2})\.(\d{3})/, '$1.$2.');
      if (value.length > 10) value = value.replace(/^(\d{2})\.(\d{3})\.(\d{3})/, '$1.$2.$3/');
      if (value.length > 15) value = value.replace(/^(\d{2})\.(\d{3})\.(\d{3})\/(\d{4})/, '$1.$2.$3/$4-');
      
      e.target.value = value;
    });

    elements.searchForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = await fetchCNPJ(elements.cnpjInput.value);
      if (data) {
        renderResult(data);
      }
    });

    elements.saveBtn.addEventListener('click', saveToHistory);

    // Initialize
    async function init() {
      if (window.elementSdk) {
        window.elementSdk.init(elementImpl);
      }
      
      if (window.dataSdk) {
        await window.dataSdk.init(dataHandler);
      }
      
      updateUI();
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ca6f38bd0e2d89c',t:'MTc3MDUwOTkyMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>